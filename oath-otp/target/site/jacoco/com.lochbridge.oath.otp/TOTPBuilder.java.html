<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOTPBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OATH OTP</a> &gt; <a href="index.source.html" class="el_package">com.lochbridge.oath.otp</a> &gt; <span class="el_source">TOTPBuilder.java</span></div><h1>TOTPBuilder.java</h1><pre class="source lang-java linenums">package com.lochbridge.oath.otp;

import java.lang.reflect.UndeclaredThrowableException;
import java.security.GeneralSecurityException;
import java.util.concurrent.TimeUnit;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;

import com.google.common.base.Preconditions;
import com.google.common.base.Strings;
import com.google.common.collect.Range;
import com.google.common.io.BaseEncoding;

/**
 * A Time-based One-time Password (TOTP) builder. 
 * &lt;p&gt;
 * This is an implementation of the OATH TOTP algorithm as described by RFC 6238. This implementation supports numeric-only TOTP values 
 * ranging from size 6 to 8 (inclusive).
 * &lt;/p&gt;
 * &lt;p&gt;
 * The builder, obtained via a call to the static {@code key(...)} method on {@link TOTP}, provides methods for
 * configuring the TOTP generation parameters. Once the TOTP configuration is prepared, the builder is used to build 
 * a {@link TOTP} using the {@code build()} or {@code build(time)} methods:
 * &lt;/p&gt;
 * &lt;pre&gt;
 *   // Use a 64 byte shared secret key (we use 64 bytes since we will be using HMAC-SHA-512 when generating the TOTP).
 *   String sharedSecretKey = &quot;1234567890123456789012345678901234567890123456789012345678901234&quot;; // 64 bytes
 *   byte[] key = sharedSecretKey.getBytes(Charsets.US_ASCII);
 *   
 *   // Generate an 8-digit TOTP using a 30 second time step, HMAC-SHA-512, and the 64 byte shared secret key.
 *   TOTP totp = TOTP.key(key).timeStep(TimeUnit.SECONDS.toMillis(30)).digits(8).hmacSha512().build();
 *   System.out.println(&quot;TOTP = &quot; + totp.value());
 *   
 *   // Example of generating a TOTP using the default values: 6-digit, 30 second time-step size, HMAC-SHA-1
 *   sharedSecretKey = &quot;12345678901234567890&quot;; // 20 bytes
 *   key = sharedSecretKey.getBytes(Charsets.US_ASCII);
 *   totp = TOTP.key(key).build();
 *   System.out.println(&quot;TOTP = &quot; + totp.value());
 * &lt;/pre&gt;
 *
 * @author Johan Rydell, PortWise, Inc.
 * @author Johnny Mongiat
 * 
 * @see http://tools.ietf.org/html/rfc6238
 */
public final class TOTPBuilder {
	
	/** The default time step size (30 seconds). */
<span class="fc" id="L50">	public static final long DEFAULT_TIME_STEP = TimeUnit.SECONDS.toMillis(30);</span>
	
	/** The default number of digits the TOTP value contains. */
	public static final int DEFAULT_DIGITS = 6;
	
	/** The minimum allowed number of digits the TOTP value can contain. */
	public static final int MIN_ALLOWED_DIGITS = 6;
	
	/** The maximum allowed number of digits the TOTP value can contain. */
	public static final int MAX_ALLOWED_DIGITS = 8;
    
    /** The shared secret key. */
    private final byte[] key;
    
    /** The time step size (defaults to {@link #DEFAULT_TIME_STEP}). */
<span class="fc" id="L65">    private long timeStep = DEFAULT_TIME_STEP;</span>
    
    /** The number of digits the TOTP value contains (defaults to {@link #DEFAULT_DIGITS}). */
<span class="fc" id="L68">    private int digits = DEFAULT_DIGITS;</span>
    
    /** The HMAC-SHA algorithm used in generating the TOTP value (defaults to {@code HMAC-SHA-1}). */
<span class="fc" id="L71">    private HmacShaAlgorithm hmacShaAlgorithm = HmacShaAlgorithm.HMAC_SHA_1;</span>
    
    /**
     * Creates a new instance of {@code TOTPBuilder} initialised with a shared secret key.
     * 
     * @param key the shared secret key. The contents of the array are copied to protect against subsequent modification.
     * 
     * @throws NullPointerException if {@code key} is {@code null}.
     */
<span class="fc" id="L80">	TOTPBuilder(byte[] key) {</span>
<span class="fc" id="L81">		Preconditions.checkNotNull(key);</span>
<span class="fc" id="L82">		this.key = new byte[key.length];</span>
<span class="fc" id="L83">		System.arraycopy(key, 0, this.key, 0, key.length);</span>
<span class="fc" id="L84">	}</span>
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the specified {@code timeStep} size.
	 * 
	 * @param timeStep the time step size in milliseconds
	 * 
	 * @return this {@code TOTPBuilder} instance initialised with the specified {@code timeStep} size.
	 * 
	 * @throws IllegalArgumentException if {@code timeStep} is &lt;= 0.
	 */
	public TOTPBuilder timeStep(long timeStep) {
<span class="fc bfc" id="L96" title="All 2 branches covered.">		Preconditions.checkArgument(timeStep &gt; 0);</span>
<span class="fc" id="L97">		this.timeStep = timeStep;</span>
<span class="fc" id="L98">		return this;</span>
	}
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the specified {@code digits}.
	 * 
	 * @param digits the number of digits the generated TOTP value should contain 
	 *        (must be between {@link #MIN_ALLOWED_DIGITS} and {@link #MAX_ALLOWED_DIGITS} inclusive)
	 *        
	 * @return this {@code TOTPBuilder} instance initialised with the specified {@code digits}.
	 * 
	 * @throws IllegalArgumentException if {@code digits} is not in [{@link #MIN_ALLOWED_DIGITS}, {@link #MAX_ALLOWED_DIGITS}].
	 */
	public TOTPBuilder digits(int digits) {
<span class="fc" id="L112">		Preconditions.checkArgument(Range.closed(MIN_ALLOWED_DIGITS, MAX_ALLOWED_DIGITS).contains(digits));</span>
<span class="fc" id="L113">		this.digits = digits;</span>
<span class="fc" id="L114">		return this;</span>
	}
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the specified HMAC-SHA {@code algorithm}.
	 * 
	 * @param algorithm the HMAC-SHA algorithm used in generating the TOTP value
	 * 
	 * @return this {@code TOTPBuilder} instance initialised with the specified HMAC-SHA {@code algorithm}.
	 * 
	 * @throws NullPointerException if {@code algorithm} is {@code null}.
	 */
	public TOTPBuilder hmacSha(HmacShaAlgorithm algorithm) {
<span class="fc" id="L127">		Preconditions.checkNotNull(algorithm);</span>
<span class="fc" id="L128">		this.hmacShaAlgorithm = algorithm;</span>
<span class="fc" id="L129">		return this;</span>
	}
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_1}.
	 * 
	 * @return this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_1}.
	 */
	public TOTPBuilder hmacSha1() {
<span class="fc" id="L138">		return hmacSha(HmacShaAlgorithm.HMAC_SHA_1);</span>
	}
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_256}.
	 * 
	 * @return this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_256}.
	 */
	public TOTPBuilder hmacSha256() {
<span class="fc" id="L147">		return hmacSha(HmacShaAlgorithm.HMAC_SHA_256);</span>
	}
	
	/**
	 * Returns this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_512}.
	 * 
	 * @return this {@code TOTPBuilder} instance initialised with the {@link HmacShaAlgorithm.HMAC_SHA_512}.
	 */
	public TOTPBuilder hmacSha512() {
<span class="fc" id="L156">		return hmacSha(HmacShaAlgorithm.HMAC_SHA_512);</span>
	}
	
	/**
	 * Build a Time-based One-time Password {@link TOTP} using the current system time (current time in milliseconds since the UNIX epoch).
	 * Note that the builder instance can be reused for subsequent configuration/generation calls.
	 * 
	 * @return a Time-based One-time Password {@link TOTP} instance.
	 */
	public TOTP build() {
<span class="fc" id="L166">		long time = System.currentTimeMillis();</span>
<span class="fc" id="L167">		return new TOTP(generateTOTP(time), time, hmacShaAlgorithm, digits, timeStep);</span>
	}
	
	/**
	 * Build a Time-based One-time Password {@link TOTP} using an arbitrary time. Note that the builder
	 * instance can be reused for subsequent configuration/generation calls.
	 * 
	 * @param time the time (in milliseconds) (must be &gt;= 0)
	 * 
	 * @return a Time-based One-time Password {@link TOTP} instance.
	 * 
	 * @throws IllegalArgumentException if {@code time} &lt; 0.
	 */
	public TOTP build(long time) {
<span class="fc bfc" id="L181" title="All 2 branches covered.">		Preconditions.checkArgument(time &gt;= 0);</span>
<span class="fc" id="L182">		return new TOTP(generateTOTP(time), time, hmacShaAlgorithm, digits, timeStep);</span>
	}

	/**
	 * Returns the HMAC-SHA hash with {@code keyBytes} as the key, and {@code text} as the message.
	 *
	 * @param keyBytes the bytes to use for the HMAC key
	 * @param text the message or text to be authenticated
	 * 
	 * @return the HMAC-SHA hash with {@code keyBytes} as the key, and {@code text} as the message.
	 */
	private byte[] computeHmacSha(byte[] keyBytes, byte[] text) {
		try {
<span class="fc" id="L195">			Mac hmac = Mac.getInstance(hmacShaAlgorithm.getAlgorithm());</span>
<span class="fc" id="L196">			SecretKeySpec macKey = new SecretKeySpec(keyBytes, &quot;RAW&quot;);</span>
<span class="fc" id="L197">			hmac.init(macKey);</span>
<span class="fc" id="L198">			return hmac.doFinal(text);</span>
<span class="nc" id="L199">		} catch (GeneralSecurityException gse) {</span>
<span class="nc" id="L200">			throw new UndeclaredThrowableException(gse);</span>
		}
	}

	/**
	 * Returns the Time-based One-time Password value against an arbitrary {@code time} using the set of parameters configured in this builder.
	 * The value will contain {@link #digits(int)} digits.
	 *
	 * @param time the time (in milliseconds)
	 *
	 * @return the Time-based One-time Password value as numeric String in base 10 that includes {@link #digits(int)} digits.
	 */
	private String generateTOTP(long time) {
		// Calculate the number of time steps between the initial counter time (i.e. T0 = 0 = Unix epoch) and the specified 'time'.
<span class="fc" id="L214">		final long tc = (long) Math.floor(time / timeStep);</span>
		
		// Using the counter
		// First 8 bytes are for the movingFactor
		// Compliant with base RFC 4226 (HOTP)
<span class="fc" id="L219">        String timeInHex = Strings.padStart(Long.toHexString(tc).toUpperCase(), 16, '0');</span>

		// Step 1: Generate the HMAC-SHA hash.
<span class="fc" id="L222">        byte[] msg = BaseEncoding.base16().decode(timeInHex);</span>
<span class="fc" id="L223">		byte[] hash = computeHmacSha(key, msg);</span>

		// Step 2: Dynamic Truncation as per RFC 4226 (HOTP).
		// See section 5.3 of RFC 4226: 
		//   - &quot;... Let OffsetBits be the low-order 4 bits of String[19] (where String = String[0]...String[19]) ...&quot;
		//   - &quot;... Let P = String[OffSet]...String[OffSet+3] ... Return the Last 31 bits of P ...&quot;
<span class="fc" id="L229">		int offset = hash[hash.length - 1] &amp; 0xf;</span>
<span class="fc" id="L230">		int binary = ((hash[offset] &amp; 0x7f) &lt;&lt; 24) | ((hash[offset + 1] &amp; 0xff) &lt;&lt; 16) | ((hash[offset + 2] &amp; 0xff) &lt;&lt; 8) | (hash[offset + 3] &amp; 0xff);</span>

		// Step 3: Compute the TOTP value.
<span class="fc" id="L233">		int otp = binary % ((int) Math.pow(10, digits));</span>

		// Ensure the TOTP value contains the specified number of digits.
<span class="fc" id="L236">		return Strings.padStart(Integer.toString(otp), digits, '0');</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>